# docs/appeals.swagger.yaml
openapi: 3.0.3
info:
  title: Smart City - Appeals API
  version: 1.0.0
  description: Fuqarolar murojaatlari (appeals) boshqaruvi uchun to'liq API

paths:
  # ── PUBLIC ROUTES ─────────────────────
  /sectors/appeals:
    post:
      tags: [Appeals]
      summary: Yangi murojaat yaratish
      description: Fuqaro tomonidan yangi murojaat yuborish (auth talab qilinmaydi)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AppealCreate'
      responses:
        '201':
          description: Murojaat muvaffaqiyatli yaratildi
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/responses/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Appeal'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

    get:
      tags: [Appeals]
      summary: Barcha murojaatlarni olish (filtrlar bilan)
      description: Ochik murojaatlarni umumiy ko'rish uchun (public read)
      parameters:
        - $ref: '#/components/parameters/page'
        - $ref: '#/components/parameters/limit'
        - $ref: '#/components/parameters/status'
        - $ref: '#/components/parameters/type'
        - $ref: '#/components/parameters/sector'
        - $ref: '#/components/parameters/search'
        - $ref: '#/components/parameters/sortBy'
        - $ref: '#/components/parameters/sortOrder'
      responses:
        '200':
          description: Murojaatlar muvaffaqiyatli olindi
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/responses/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Appeal'
                      pagination:
                        $ref: '#/components/schemas/Pagination'
        '500':
          $ref: '#/components/responses/InternalError'

  /sectors/appeals/my:
    get:
      tags: [Appeals]
      summary: O'z murojaatlarini ko'rish
      description: Foydalanuvchi o'zi yuborgan murojaatlarni ko'rish
      parameters:
        - in: query
          name: email
          schema:
            type: string
            format: email
          description: Email orqali filtr (agar berilmasa, avto aniqlanadi)
      responses:
        '200':
          description: Foydalanuvchi murojaatlari
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/responses/SuccessResponse'
                  - properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Appeal'
        '500':
          $ref: '#/components/responses/InternalError'

  /sectors/appeals/{id}:
    get:
      tags: [Appeals]
      summary: Murojaatni ID bo'yicha olish
      parameters:
        - $ref: '#/components/parameters/idParam'
      responses:
        '200':
          description: Murojaat topildi
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/responses/SuccessResponse'
                  - properties:
                      data:
                        $ref: '#/components/schemas/Appeal'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'
    delete:
      tags: [Appeals]
      summary: Murojaatni o'chirish
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/idParam'
      responses:
        '200':
          $ref: '#/components/responses/SuccessResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/ForbiddenAdmin'
        '404':
          $ref: '#/components/responses/NotFound'

  /sectors/appeals/{id}/rate:
    post:
      tags: [Appeals]
      summary: Murojaatni baholash
      description: Yopilgan murojaatga baho qo'yish (1-5)
      parameters:
        - $ref: '#/components/parameters/idParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AppealRating'
      responses:
        '200':
          $ref: '#/components/responses/SuccessResponse'
        '400':
          description: Murojaat yopilmagan yoki allaqachon baholangan
        '404':
          $ref: '#/components/responses/NotFound'

  # ── AUTH REQUIRED (Admin / Sector Admin) ─────────────────────
  /sectors/appeals/sectors:
    get:
      tags: [Appeals]
      summary: Mavjud sektorlar va ular bo'yicha statistika
      description: Admin va sektor adminlari uchun sektorlar ro'yxati va murojaat soni
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Sektorlar va statistika
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/responses/SuccessResponse'
                  - properties:
                      data:
                        type: object
                        properties:
                          sectors:
                            type: array
                            items:
                              type: object
                              properties:
                                sector: { type: string }
                                sectorName: { type: string }
                                counts:
                                  type: object
                                  properties:
                                    total: { type: integer }
                                    open: { type: integer }
                                    inProgress: { type: integer }
                                    closed: { type: integer }
                                percentage:
                                  type: object
                                  properties:
                                    open: { type: string }
                                    inProgress: { type: string }
                                    closed: { type: string }
                          userAccess:
                            type: object
                            properties:
                              role: { type: string }
                              sector: { type: string }
                              canAccessAll: { type: boolean }
                              sectorRestricted: { type: boolean }
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /sectors/appeals/sector-appeals/{sector}:
    get:
      tags: [Appeals]
      summary: Muayyan sektor bo'yicha murojaatlar
      description: Faqat ruxsatli sektor yoki adminlar uchun
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: sector
          required: true
          schema:
            type: string
            enum: [infrastructure, environment, ecology, transport, health, education, social, economic, utilities, other]
          description: Sektor nomi
        - $ref: '#/components/parameters/page'
        - $ref: '#/components/parameters/limit'
        - $ref: '#/components/parameters/status'
        - $ref: '#/components/parameters/type'
        - $ref: '#/components/parameters/search'
        - $ref: '#/components/parameters/sortBy'
        - $ref: '#/components/parameters/sortOrder'
      responses:
        '200':
          description: Sektor bo'yicha murojaatlar
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/responses/SuccessResponse'
                  - properties:
                      data:
                        type: object
                        properties:
                          appeals:
                            type: array
                            items:
                              $ref: '#/components/schemas/Appeal'
                          sectorInfo:
                            type: object
                            properties:
                              sector: { type: string }
                              sectorName: { type: string }
                              totalAppeals: { type: integer }
                          statistics:
                            $ref: '#/components/schemas/AppealStatistics'
                      pagination:
                        $ref: '#/components/schemas/Pagination'
        '400':
          description: Noto'g'ri sektor
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  # ── ADMIN ONLY ROUTES ─────────────────────
  /sectors/appeals/{id}/status:
    put:
      tags: [Appeals]
      summary: Murojaat holatini o'zgartirish
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/idParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AppealStatusUpdate'
      responses:
        '200':
          $ref: '#/components/responses/SuccessResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/ForbiddenAdmin'
        '404':
          $ref: '#/components/responses/NotFound'

  /sectors/appeals/admin/bulk-status:
    patch:
      tags: [Appeals]
      summary: Bir nechta murojaatni bir vaqtda yangilash
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BulkStatusUpdate'
      responses:
        '200':
          description: Bulk update muvaffaqiyatli
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/responses/SuccessResponse'
                  - properties:
                      data:
                        type: object
                        properties:
                          updatedCount: { type: integer }
                          failedIds: { type: array, items: { type: string } }
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/ForbiddenAdmin'

  # ── ANALYTICS & REPORTS ─────────────────────
  /sectors/appeals/admin/statistics:
    get:
      tags: [Appeals - Analytics]
      summary: Umumiy statistika
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: period
          schema:
            type: integer
            minimum: 1
            maximum: 365
          description: So'nggi kunlar soni
      responses:
        '200':
          $ref: '#/components/responses/SuccessResponse'

  /sectors/appeals/admin/dashboard:
    get:
      tags: [Appeals - Analytics]
      summary: Dashboard ma'lumotlari
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/periodQuery'
      responses:
        '200':
          $ref: '#/components/responses/SuccessResponse'

  /sectors/appeals/admin/export:
    get:
      tags: [Appeals - Export]
      summary: CSV formatida eksport qilish
      security:
        - bearerAuth: []
      produces:
        - text/csv
      parameters:
        - $ref: '#/components/parameters/page'
        - $ref: '#/components/parameters/limit'
        - $ref: '#/components/parameters/status'
        - $ref: '#/components/parameters/sector'
      responses:
        '200':
          description: CSV fayl
          content:
            text/csv:
              schema:
                type: string
                format: binary

  /sectors/appeals/health:
    get:
      tags: [Appeals]
      summary: Service health check
      responses:
        '200':
          description: Service ishlamoqda
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean, example: true }
                  message: { type: string, example: "Appeals service is running" }
                  timestamp: { type: string, format: date-time }
                  uptime: { type: number }

components:
  schemas:
    Appeal:
      type: object
      properties:
        _id: { type: string }
        fullName: { type: string }
        email: { type: string, format: email }
        phone: { type: string }
        message: { type: string }
        type: { type: string, enum: [complaint, suggestion, question, request, appreciation, other] }
        sector: { type: string, enum: [infrastructure, environment, ecology, transport, health, education, social, economic, utilities, other] }
        company: { type: string }
        status: { type: string, enum: [open, in_progress, waiting_response, closed, rejected] }
        rating:
          type: object
          nullable: true
          properties:
            score: { type: integer, minimum: 1, maximum: 5 }
            feedback: { type: string }
            ratedAt: { type: string, format: date-time }
        adminResponse:
          type: object
          nullable: true
          properties:
            message: { type: string }
            respondedBy: { type: string }
            respondedAt: { type: string, format: date-time }
        location:
          type: object
          properties:
            district: { type: string }
            address: { type: string }
            coordinates:
              type: object
              properties:
                latitude: { type: number }
                longitude: { type: number }
        attachments:
          type: array
          items:
            type: object
            properties:
              filename: { type: string }
              originalName: { type: string }
              mimetype: { type: string }
              size: { type: integer }
              uploadDate: { type: string, format: date-time }
        followUpRequired: { type: boolean }
        followUpDate: { type: string, format: date }
        ipAddress: { type: string }
        userAgent: { type: string }
        viewCount: { type: integer }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }

    AppealCreate:
      type: object
      required: [fullName, message, type, sector, company]
      properties:
        fullName: { type: string, minLength: 2, maxLength: 50 }
        email: { type: string, format: email }
        phone: { type: string, pattern: '^[\+]?[0-9\s\-\(\)]{10,}$' }
        message: { type: string, minLength: 10, maxLength: 2000 }
        type: { type: string, enum: [complaint, suggestion, question, request, appreciation, other] }
        sector: { type: string, enum: [infrastructure, environment, ecology, transport, health, education, social, economic, utilities, other] }
        company: { type: string }
        location:
          type: object
          properties:
            district: { type: string, maxLength: 100 }
            address: { type: string, maxLength: 500 }
            coordinates:
              type: object
              properties:
                latitude: { type: number }
                longitude: { type: number }

    AppealStatusUpdate:
      type: object
      properties:
        status: { type: string, enum: [open, in_progress, waiting_response, closed, rejected] }
        adminResponse: { type: string, maxLength: 1000 }
        followUpRequired: { type: boolean }
        followUpDate: { type: string, format: date }

    AppealRating:
      type: object
      required: [score]
      properties:
        score: { type: integer, minimum: 1, maximum: 5 }
        feedback: { type: string, maxLength: 500 }

    BulkStatusUpdate:
      type: object
      required: [appealIds, status]
      properties:
        appealIds:
          type: array
          minItems: 1
          items: { type: string }
        status: { type: string, enum: [open, in_progress, waiting_response, closed, rejected] }
        adminResponse: { type: string, maxLength: 1000 }

    Pagination:
      type: object
      properties:
        currentPage: { type: integer }
        totalPages: { type: integer }
        totalItems: { type: integer }
        itemsPerPage: { type: integer }
        hasNextPage: { type: boolean }
        hasPrevPage: { type: boolean }

    AppealStatistics:
      type: object
      properties:
        totalAppeals: { type: integer }
        byStatus:
          type: array
          items:
            type: object
            properties:
              _id: { type: string }
              count: { type: integer }

  parameters:
    idParam:
      name: id
      in: path
      required: true
      schema:
        type: string
      description: Murojaat ID (MongoDB ObjectId)
    page:
      name: page
      in: query
      schema:
        type: integer
        minimum: 1
        default: 1
    limit:
      name: limit
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20
    status:
      name: status
      in: query
      schema:
        type: string
        enum: [open, in_progress, waiting_response, closed, rejected]
    type:
      name: type
      in: query
      schema:
        type: string
        enum: [complaint, suggestion, question, request, appreciation, other]
    sector:
      name: sector
      in: query
      schema:
        type: string
        enum: [infrastructure, environment, ecology, transport, health, education, social, economic, utilities, other]
    search:
      name: search
      in: query
      schema:
        type: string
    sortBy:
      name: sortBy
      in: query
      schema:
        type: string
        enum: [createdAt, updatedAt, status]
        default: createdAt
    sortOrder:
      name: sortOrder
      in: query
      schema:
        type: string
        enum: [asc, desc]
        default: desc
    periodQuery:
      name: period
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 365
        default: 30

  responses:
    SuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: Amal muvaffaqiyatli bajarildi
        data:
          type: object
          nullable: true

    BadRequest:
      description: Noto'g'ri ma'lumot kiritildi
      content:
        application/json:
          schema:
            type: object
            properties:
              success: { type: boolean, example: false }
              message: { type: string }
              errors: { type: array, items: { type: string } }

    Unauthorized:
      description: Autentifikatsiya talab qilinadi
    Forbidden:
      description: Ruxsat yo'q (masalan, sektor admin boshqa sektorga kirmoqchi)
    ForbiddenAdmin:
      description: Faqat admin yoki super_admin kirishi mumkin
    NotFound:
      description: Murojaat topilmadi
    InternalError:
      description: Server xatosi

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT